
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Zohar - AI Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            text-align: right;
        }
        .assistant-message {
            background-color: #e9ecef;
            color: #333;
        }
        .sidebar {
            height: 100vh;
            overflow-y: auto;
        }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 bg-light sidebar">
                <h4 class="p-3">Project Zohar</h4>
                
                <!-- Connection Status -->
                <div class="p-3">
                    <h6>System Status</h6>
                    <div id="connection-status">
                        <span class="status-indicator status-connecting"></span>
                        <span>Connecting...</span>
                    </div>
                </div>
                
                <!-- Settings -->
                <div class="p-3">
                    <h6>Settings</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="agent" id="personal-agent" value="personal" checked>
                        <label class="form-check-label" for="personal-agent">Personal Agent</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="agent" id="public-agent" value="public">
                        <label class="form-check-label" for="public-agent">Public Agent</label>
                    </div>
                </div>
                
                <!-- File Upload -->
                <div class="p-3">
                    <h6>File Upload</h6>
                    <input type="file" id="file-upload" class="form-control" accept=".txt,.pdf,.docx,.csv,.json">
                    <button class="btn btn-sm btn-primary mt-2" onclick="uploadFile()">Upload</button>
                </div>
                
                <!-- Setup Wizard -->
                <div class="p-3">
                    <h6>Setup</h6>
                    <a href="/setup" class="btn btn-outline-primary btn-sm w-100 mb-2">
                        <i class="fas fa-cog"></i> Setup Wizard
                    </a>
                </div>
                
                <!-- Platform Status -->
                <div class="p-3">
                    <h6>Platforms</h6>
                    <div id="platform-status"></div>
                </div>
            </div>
            
            <!-- Main Chat Area -->
            <div class="col-md-9">
                <div class="p-3">
                    <h2>AI Assistant Chat</h2>
                    
                    <!-- Chat Messages -->
                    <div id="chat-container" class="chat-container mb-3"></div>
                    
                    <!-- Message Input -->
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" placeholder="Type your message...">
                        <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let websocket;
        let currentUserId = 'default_user';
        
        // Initialize WebSocket connection
        function initWebSocket() {
            websocket = new WebSocket(`ws://localhost:8000/ws/${currentUserId}`);
            
            websocket.onopen = function(event) {
                updateConnectionStatus('connected');
                console.log('WebSocket connected');
            };
            
            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            websocket.onclose = function(event) {
                updateConnectionStatus('disconnected');
                console.log('WebSocket disconnected');
                // Attempt to reconnect after 5 seconds
                setTimeout(initWebSocket, 5000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus('disconnected');
            };
        }
        
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connection-status');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span:last-child');
            
            indicator.className = `status-indicator status-${status}`;
            
            switch(status) {
                case 'connected':
                    text.textContent = 'Connected';
                    break;
                case 'disconnected':
                    text.textContent = 'Disconnected';
                    break;
                case 'connecting':
                    text.textContent = 'Connecting...';
                    break;
            }
        }
        
        function handleWebSocketMessage(message) {
            if (message.type === 'chat_response') {
                addMessage(message.response, 'assistant');
            } else if (message.type === 'pong') {
                console.log('Pong received');
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (message && websocket && websocket.readyState === WebSocket.OPEN) {
                addMessage(message, 'user');
                
                const agentType = document.querySelector('input[name="agent"]:checked').value;
                
                websocket.send(JSON.stringify({
                    type: 'chat',
                    content: message,
                    agent_type: agentType
                }));
                
                input.value = '';
            }
        }
        
        function addMessage(text, sender) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function uploadFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        filename: file.name,
                        content: btoa(e.target.result),
                        content_type: file.type
                    };
                    
                    fetch('/api/upload', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(fileData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addMessage(`File "${file.name}" uploaded successfully`, 'assistant');
                        } else {
                            addMessage(`Failed to upload file: ${data.error}`, 'assistant');
                        }
                    });
                };
                reader.readAsBinaryString(file);
            }
        }
        
        // Handle Enter key in message input
        document.getElementById('message-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Initialize WebSocket when page loads
        window.addEventListener('load', function() {
            initWebSocket();
            
            // Send ping every 30 seconds to keep connection alive
            setInterval(function() {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send(JSON.stringify({type: 'ping'}));
                }
            }, 30000);
        });
    </script>
</body>
</html>
        